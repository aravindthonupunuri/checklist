services:
  backpackregistrypostgres:
    image: 'postgres:11.5'
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=grws
    ports:
      - '5432:5432'
  zookeeper:
    image: 'wurstmeister/zookeeper:3.4.6'
    ports:
      - '2181:2181'
  kafka:
    image: 'wurstmeister/kafka:2.12-2.3.0'
    ports:
      - '9092:9092'
    environment:
      - KAFKA_ADVERTISED_HOST_NAME=kafka
      - KAFKA_ADVERTISE_HOST_PORT=9092
      - 'KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181'
      - 'KAFKA_CREATE_TOPICS=lists-msg-bus:1:1,lists-dlq:1:1'
pipeline:
  restore_cache:
    image: 'docker.target.com/drone/drone-s3-cache:2'
    pull: true
    restore: true
    secrets:
      - cache_s3_server
      - cache_s3_access_key
      - cache_s3_secret_key
      - cache_s3_ca_cert

  publish-config-backpack-registry-dev:
    when:
      event: [push]
      branch: master
    image: 'docker.target.com/app/lists/alpine-bash-curl-ssl:1.0.5'
    environment:
      CICD_MODE: 'true'
    secrets:
      - TAP_API_TOKEN
      - backpack_registry_app_private_key_dev
      - backpack_registry_consumer_app_private_key_dev
    commands:
      - 'tap_api_token=$TAP_API_TOKEN app_private_key=$BACKPACK_REGISTRY_APP_PRIVATE_KEY_DEV ./backpack-registry-app/scripts/config_deploy_manager.sh conf.dev.0.0'
      - 'tap_api_token=$TAP_API_TOKEN app_private_key=$BACKPACK_REGISTRY_CONSUMER_APP_PRIVATE_KEY_DEV ./backpack-registry-consumer-app/scripts/config_deploy_manager.sh conf.dev.0.0'

  publish-config-backpack-registry-stage:
    when:
      event: tag
      ref: 'refs/tags/conf.stage.backpackregistry.*'
      branch: master
    image: 'docker.target.com/app/lists/alpine-bash-curl-ssl:1.0.5'
    environment:
      CICD_MODE: 'true'
    secrets:
      - TAP_API_TOKEN
      - backpack_registry_app_private_key_stage
      - backpack_registry_consumer_app_private_key_stage
    commands:
      - 'tap_api_token=$TAP_API_TOKEN app_private_key=$BACKPACK_REGISTRY_APP_PRIVATE_KEY_STAGE ./backpack-registry-app/scripts/config_deploy_manager.sh ${DRONE_TAG}'
      - 'tap_api_token=$TAP_API_TOKEN app_private_key=$BACKPACK_REGISTRY_CONSUMER_APP_PRIVATE_KEY_STAGE ./backpack-registry-consumer-app/scripts/config_deploy_manager.sh ${DRONE_TAG}'

  build:
    when:
      event: [pull_request, push, tag]
    image: 'docker.target.com/tap/alpine-openjdk11-build:latest'
    environment:
      JAVA_TOOL_OPTIONS: '-Xmx4000M'
      GRADLE_USER_HOME: .gradle
      GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=1 -Dorg.gradle.parallel=false'
      JDBC_URL: 'jdbc:postgresql://backpackregistrypostgres:5432/grws'
      KAFKA_BOOTSTRAP_SERVERS: 'kafka:9092'
    commands:
      - './gradlew build distTar'

  rebuild_cache:
    image: 'docker.target.com/drone/drone-s3-cache:2'
    rebuild: true
    secrets:
      - cache_s3_server
      - cache_s3_access_key
      - cache_s3_secret_key
      - cache_s3_ca_cert
    mount:
      - .gradle

  flush_cache:
    image: 'docker.target.com/drone/drone-s3-cache:2'
    secrets:
      - cache_s3_server
      - cache_s3_access_key
      - cache_s3_secret_key
      - cache_s3_ca_cert
    flush: true
    flush_age: 14

  publish-docker-backpack-registry-app-dev:
    image: plugins/docker
    group: devimggroup
    registry: docker.target.com
    repo: docker.target.com/app/backpack-registry/backpack-registry-app
    dockerfile: ./backpack-registry-app/Dockerfile
    tags:
      - 'b${DRONE_BUILD_NUMBER}-${DRONE_COMMIT:0:8}'
      - latest
    when:
      event: [push]
      branch: master
    secrets:
      - {source: artifactory_username, target: plugin_username}
      - {source: artifactory_password, target: plugin_password}

  publish-docker-backpack-registry-app-stage:
    image: 'plugins/docker:latest'
    group: stgimggroup
    registry: docker.target.com
    repo: docker.target.com/app/backpack-registry/backpack-registry-app
    dockerfile: ./backpack-registry-app/Dockerfile
    tags: 'rc.${DRONE_TAG:28}'
    when:
      event: tag
      branch: master
      ref: 'refs/tags/conf.stage.backpackregistry.*'
    secrets:
      - {source: artifactory_username, target: plugin_username}
      - {source: artifactory_password, target: plugin_password}

  publish-docker-backpack-registry-consumer-app-dev:
    image: plugins/docker
    environment:
      CICD_MODE: 'true'
    group: devimggroup
    registry: docker.target.com
    repo: docker.target.com/app/backpack-registry/backpack-registry-consumer-app
    dockerfile: ./backpack-registry-consumer-app/Dockerfile
    tags:
      - 'b${DRONE_BUILD_NUMBER}-${DRONE_COMMIT:0:8}'
      - latest
    when:
      event: [push]
      branch: master
    secrets:
      - {source: artifactory_username, target: plugin_username}
      - {source: artifactory_password, target: plugin_password}

  publish-docker-backpack-registry-consumer-app-stage:
    image: 'plugins/docker:latest'
    environment:
      CICD_MODE: 'true'
    group: stgimggroup
    registry: docker.target.com
    repo: docker.target.com/app/backpack-registry/backpack-registry-consumer-app
    dockerfile: ./backpack-registry-consumer-app/Dockerfile
    tags: 'rc.${DRONE_TAG:28}'
    when:
      event: tag
      branch: master
      ref: 'refs/tags/conf.stage.backpackregistry.*'
    secrets:
      - {source: artifactory_username, target: plugin_username}
      - {source: artifactory_password, target: plugin_password}

  publish-client:
    when:
      event: tag
      branch: master
      ref: 'refs/tags/client.*'
    image: 'docker.target.com/tap/alpine-openjdk11-build:latest'
    environment:
      JAVA_TOOL_OPTIONS: '-Xmx4000M'
      GRADLE_USER_HOME: .gradle
      GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=1 -Dorg.gradle.parallel=false'
      JDBC_URL: 'jdbc:postgresql://backpackregistrypostgres:5432/grws'
      KAFKA_BOOTSTRAP_SERVERS: 'kafka:9092'
    commands:
      - ./gradlew publish -DUSERNAME=$ARTIFACTORY_USERNAME -DPASSWORD=$ARTIFACTORY_PASSWORD -DVERSION="${DRONE_TAG:7}"
    secrets: [ ARTIFACTORY_USERNAME, ARTIFACTORY_PASSWORD ]

secrets:
  cache_s3_server:
    path: secret/shared/drone/prod-secrets/cache_s3_server
  cache_s3_access_key:
    path: secret/shared/drone/prod-secrets/cache_s3_access_key
  cache_s3_secret_key:
    path: secret/shared/drone/prod-secrets/cache_s3_secret_key
  cache_s3_ca_cert:
    path: secret/shared/drone/prod-secrets/cache_s3_ca_cert
  backpack_registry_app_private_key_dev:
    path: secret/repo/Registry-Modernization/backpack-registry/backpackregistry-privkey-dev
  backpack_registry_app_private_key_stage:
    path: secret/repo/Registry-Modernization/backpack-registry/backpackregistry-privkey-stage
  backpack_registry_consumer_app_private_key_dev:
    path: secret/repo/Registry-Modernization/backpack-registry/backpackregistryconsumer-privkey-dev
  backpack_registry_consumer_app_private_key_stage:
    path: secret/repo/Registry-Modernization/backpack-registry/backpackregistryconsumer-privkey-stage
